[トップページに戻る](README.md)

# [FTKR_AISkillEvaluate](FTKR_AISkillEvaluate.js) プラグイン

自動戦闘時に使用するスキルの評価値を変更するプラグインです。

ダウンロード: [FTKR_AISkillEvaluate.js](https://raw.githubusercontent.com/futokoro/RPGMaker/master/FTKR_AISkillEvaluate.js)

# 目次

以下の項目の順でプラグインの使い方を説明します。
1. [概要](#概要)
2. [プラグインの登録](#プラグインの登録)
1. [スキルごとの評価値計算式の設定](#スキルごとの評価値計算式の設定)
    1. [自動戦闘時の評価値計算式](#自動戦闘時の評価値計算式)
    1. [評価値式の記述](#評価値式の記述)
1. [行動評価のモデル](#行動評価のモデル)
    1. [行動評価のモデルの構成](#行動評価のモデルの構成)
    1. [行動評価リストの構成](#行動評価リストの構成)
    1. [アクターへの評価モデルの設定](#アクターへの評価モデルの設定)
1. [作戦画面](#作戦画面)
1. [FTKR_ExBattleCommandの追加コマンド設定](#ftkr_exbattlecommandの追加コマンド設定)
* [プラグインの更新履歴](#プラグインの更新履歴)
* [ライセンス](#ライセンス)

# 概要

自動戦闘時に使用するスキルを選択するための評価値計算を個別に設定できます。

また、行動評価のモデル(簡易的な作戦)を作成することができます。

設定した行動評価モデル(簡易的な作戦)をゲーム内で変更する専用画面の表示コマンドを、メニューコマンドおよびバトルのパーティーコマンドに追加できます。

[目次に戻る](#目次)

# プラグインの登録

以下のプラグインと組み合わせる場合は、プラグイン管理の順番に注意してください。
```
FTKR_AISkillEvaluate.js
↓このプラグインよりも下に登録↓
FTKR_ExBattleCommand.js
```

[目次に戻る](#目次)

# スキルごとの評価値計算式の設定

スキルのメモ欄に以下のタグを追記すると、自動戦闘時に使用するスキルを選択する評価値計算を個別に設定することができます。

### タグ
`<ASE_評価値式:***>`<br>
`<ASE_EBARUATE:***>`
* *** : 計算式

### データベースでの対象
スキル

### 効果内容
自動戦闘時に、設定した計算式に従って評価値を計算します。

計算式には、ダメージ計算式と同様の記述が可能です。
* a: 使用者(a.hp で使用者の現在HP)
* b: 対象者(b.hp で対象者の現在HP)
* item : 使用するスキル(item.mpCost でスキルの消費MP)
* number : スキルで対象者に与える予定のダメージ量

上記の評価値式を設定しない場合は、MVデフォルトの評価値計算式(※後述)を使用します。

### 入力例
```
<ASE_評価値式: number / Math.max(target.hp, 1)>
```
上記はMVデフォルトのHPダメージスキルの評価値計算式です。
与える予定のダメージを相手の現在HPで割った値が評価値になります。

[目次に戻る](#目次)

## 自動戦闘時の評価値計算式

MVのデフォルトでは、自動戦闘時には以下のルールに従い使用可能なスキルを選択可能な対象ごとに評価値を計算し、その評価値がもっとも高くなる相手に対してスキルを使用します。

1. ダメージタイプが「HPダメージ、HP回復、HP吸収」以外のスキルは評価値0
2. HPダメージの場合は、与えるダメージと相手の残りHPの比が評価値になる
3. HP回復の場合は、回復量と相手の最大HPの比が評価値になる
4. 全体を対象とするスキルは、すべての対象の評価値を合計する
5. 連続回数が設定されている場合は、算出した評価値に回数の数値をかける
6. ルール5までで評価値が 0 でなければ、その値にランダムで 0 ～ 1 を加算する

上記ルールを見て分かるとおりに、ダメージタイプがMP系やダメージタイプなしで使用効果のみ設定したスキルは、自動戦闘ではMVのデフォルトでは絶対に使用しないことになります。

当プラグインを使い、タグで評価値式をそれらのスキルに設定することで自動戦闘でも使用する可能性がでるようになります。

[目次に戻る](#目次)

## 評価値式の記述

基本的に、全体スキルや複数回攻撃スキルを除き、スキルの評価値は 0 ~ 1 の間に収まります。全体スキルや複数回攻撃スキルはその数倍です。

そのため、当プラグインで設定する評価値式の結果も、特別な理由がない限りは同等の値に収まるように設定する必要があります。

例えば、攻撃力を下げるスキルに評価値式を設定する場合
```
<ASE_評価値式:b.atk>
```
としてしまうと、ほぼ確実にそのスキルしか使用しなくなってしまいます。
また、同じ相手に何度も掛けてしまうことも考えられます。

この場合、自分の防御力と比較させるなどすると、自分の防御力よりも攻撃力が低い相手に対しては評価値が下がるため、うまく他のスキルにも分散するようになると思います。

### 入力例
```
<ASE_評価値式:b.atk / (a.def * 2)>
```

また、ステートや弱体･強化を掛けた相手に再度掛けないようにする場合は相手がステートが掛かっている場合に、評価値を 0 にする計算を加えます。

### 入力例
```
<ASE_評価値式:b.aseState(n) * b.atk / (a.def * 2)>
```

`b.aseState(n)`は ステートID n のステートが掛かっていると 0　掛かっていないと 1 になるスクリプトです。

自身に掛ける場合は、`b.ase**`の部分を`a.ase***`に変えてください。

同様に弱体や強化が掛かっているときに 0、掛かっていないときに 1 になるスクリプトは以下の通りです。
なお、n の値は以下の通りです。
```
0:最大HP、1:最大MP、2:攻撃力、3:防御力
4:魔法攻撃、5:魔法防御、6:敏捷性、7:運
```
#### 弱体が掛かっている
`b.aseDebuff(n)`

#### 弱体が２段階で掛かっている
`b.aseMaxDebuff(n)`

#### 強化が掛かっている
`b.aseBuff(n)`

#### 強化が２段階で掛かっている
`b.aseMaxBuff(n)`

また、ステートや弱体は、戦闘のターンが進めば進むほど効果が薄くなります。
そこで経過ターン数で評価値を変動させるという方法もあります。
経過ターン数は`$gameTroop.turnCount() + 1`で取得できます。

### 入力例
```
<ASE_評価値式:1 / ($gameTroop.turnCount() + 1)>
```
この場合、1ターン目で評価値が 1、2ターン目で 0.5、とターンが経過するごとにどんどん評価値小さくなります。

※スキル選択時は、まだターンが経過していないため`$gameTroop.turnCount()`は 0 から始まります。

同一ターン内で同じスキルを使わせたくない場合には、自分の前までのキャラが指定したスキルを選択したかどうか調べる必要があります。

`$gamePary.aseSkill(n)`はスキルID n のスキルを自分の前までのキャラが選択していた場合に 0、だれも選択していない場合は 1 になるスクリプトです。

### 入力例
```
<ASE_評価値式:$gamePary.aseSkill(10)>
```

[目次に戻る](#目次)

# 行動評価のモデル

評価値式の設定とは別に、大まかな行動タイプ(*1)毎にレーティングを決めてそのタイプ全体の評価値を変動させることができます。

(*1)HPダメージ系のスキルや、HP回復系、強化付与系などスキルの効果が近いものの分類

行動評価のモデルは、プラグインパラメータ`Evaluate Models`で設定します。
モデルは複数作成することができ、それらをアクターに別々に設定することができます。

例えば、攻撃を重視するアクターや回復行動を重視するアクターなどを同じスキルを覚えていてもスキルの評価をアクター毎に変えることが出来ます。

## 行動評価のモデルの構成
プラグインパラメータはリスト形式になっており、このリスト番号が評価モデルIDに
なります。(後述のアクターのメモ欄にはこの番号を使用する)

モデル名(name)と行動評価リスト(evaluate)を設定します。

## 行動評価リストの構成
この中で、具体的に行動タイプ毎にレーティングや条件を設定します。
基本的には、敵キャラに設定する行動と同じ仕組みです。
ここに設定した行動タイプに属するスキルのみ使用します。
行動毎に以下のパラメータを設定します。

* 行動タイプ(actionType)
    * セレクトボックスから設定した行動タイプを選択します。
    * なお、テキスト入力モードに変更し、直接別の数値を入力しても問題ありません。(後述：スキルへの行動タイプ設定）

* 条件(conditions)
    * その行動タイプを使用するための条件を設定します。
    * ダメージ計算式と同様の記述を使って判定式を入力します。
    * 空欄にした場合は、常に使用可能と判断します。

* レーティング(rating)
    * その行動タイプを選択する頻度を設定します。
    * 1～9の値を設定し、この値が評価値に掛けられます。

*******************************************
！！注意！！
******************
リストには、常に行動可能なスキルがある行動タイプを最低１つ設定してください。<br>
ここでの常に行動可能なスキルとは、評価値が 0 にならずコストを消費せずに使用可能なスキルのことです。<br>
例）行動タイプ：通常攻撃<br>
********************************************

## スキルへの行動タイプの設定
スキルのメモ欄に以下のタグを設定することで、行動タイプを設定できます。

`<ASE_行動タイプ:n>`
* n は行動評価リストで選択した行動タイプの数字に合わせてください。

なお、以下の設定のスキルは、上記タグを使用しなくてもプラグイン側で行動タイプを設定します。
ただし、タグ設定が優先です。
* 1:スキルID1 の攻撃
* 2:スキルID2 の防御
* 11 :ダメージのタイプが HPダメージ 
* 12 :ダメージのタイプが HP回復
* 13 :ダメージのタイプが HP吸収
* 21 :ダメージのタイプが MPダメージ 
* 22 :ダメージのタイプが MP回復
* 23 :ダメージのタイプが MP吸収
* 31 :使用効果に強化を設定したスキル
* 41 :使用効果に弱体を設定したスキル
* 51 :使用効果にステート解除、弱体解除を設定したスキル

## アクターへの評価モデルの設定
アクターのメモ欄に以下のタグを設定することで、評価モデルを設定できます。
```
<ASE_評価モデル:n>
```
* n : 評価モデルIDを設定します。
    * \v[x]でゲーム変数を設定できます。
    * なお、 0 でMVデフォルトの自動戦闘、 -1 で手動戦闘になります。

また、以下のスクリプトでアクターID n の評価モデル名を取得できます。
```
$gameActors.actor(n).evalModelname()
```

[目次に戻る](#目次)

# 作戦画面

設定した行動評価モデル(簡易的な作戦)をゲーム内で変更する専用画面の表示コマンドをメニューコマンドおよびバトルのパーティーコマンドに追加できます。

プラグインパラメータ`Menu Command`および`Party Command`で設定してください。

この時、各アクターが選択可能な作戦のリストは、アクターのメモ欄に以下のタグを記載することで設定します。

```
<ASE_作戦リスト:n1,n2,...>
```
* n1,n2,...には、プラグインパラメータ`Evaluate Models`で設定した作戦のリスト番号、MVデフォルトの自動戦闘の 0 から任意の数を記載できます。

### 入力例
```
<ASE_作戦リスト:0,1,2>
```

なお、実際の作戦画面には、これらに加えて「手動戦闘」を追加して表示します。

[目次に戻る](#目次)

# FTKR_ExBattleCommandの追加コマンド設定

FTKR_ExBattleCommandプラグインで作戦コマンドを追加するためには、プラグインパラメータ`Party Commands`の`customs`に以下の内容を追加してください。

| パラメータ | 値 | 備考 |
| --- | --- | --- |
| name | 作戦 | 任意のコマンド名にしても問題ありません。 |
| symbol |  ase | すべて小文字です。 |
| enabled | 空欄 | スクリプトで条件を追加しても問題ありません。 |
| ext | 空欄 | |
| skillId | 任意 | |

[目次に戻る](#目次)

# プラグインの更新履歴

| バージョン | 公開日 | 更新内容 |
| --- | --- | --- |
| [ver1.2.6](FTKR_AISkillEvaluate.js) | 2018/12/11 | FTKR_AlternatingTurnBattleとの競合回避<br>デフォルトの自動戦闘に変更できない不具合を修正 |
| ver1.0.0 | 2018/01/06 | 新規作成 |

# ライセンス

本プラグインはMITライセンスのもとで公開しています。

[The MIT License (MIT)](https://opensource.org/licenses/mit-license.php)

#
[目次に戻る](#目次)

[トップページに戻る](README.md)