[トップページに戻る](README.md)
[目次に戻る](FTKR_ItemCompositionSystem.ja.md#目次)

# 合成の仕組み

## 合成の基本

### 素材から選んでアイテムを合成する

合成画面では、下の図のように「アイテム」「武器」「防具」の分類で手持ちのアイテムを表示します。

![画像](image/FTKR_ItemCompositSystem/n01_003.png)

アイテムを選択すると、合成素材に使用する員数を入力します。
入力が終わると、左下の合成アイテムのスロットにアイテムが移動します。

![画像](image/FTKR_ItemCompositSystem/n01_004.png)

合成する素材が決まったら、「合成を行う」コマンドを実行します。
確認画面の有無は、プラグインパラメータで設定できます。

この合成は、レシピを知らなくても実行可能です。
レシピの素材と合っていれば、レシピの有無の関係なく、成功すれば合成アイテムを入手できます。

![画像](image/FTKR_ItemCompositSystem/n01_005.png)

合成実行後は、下の図のような合成結果が表示します。

![画像](image/FTKR_ItemCompositSystem/n01_006.png)

[上に戻る](#合成の仕組み)　　　[目次に戻る](FTKR_ItemCompositionSystem.ja.md#目次)

### レシピから選んでアイテムを合成する

素材から選ぶだけでなく、レシピから選んで合成することもできます。
コマンド「レシピから選ぶ」を選択すると、右側のアイテム欄が覚えているレシピの表示に変わります。

![画像](image/FTKR_ItemCompositSystem/n01_007.png)

なお、プラグインパラメータ`Display Recipe Materials`を有効にしていると、合成情報ウィンドウに選択中のレシピの素材アイテムを表示します。

![画像](image/FTKR_ItemCompositSystem/n01_017.png)

レシピを選択すると、生成する数の設定画面に映ります。
このとき、レシピの素材アイテムが表示します。

![画像](image/FTKR_ItemCompositSystem/n01_008.png)

数の設定が終わると、レシピの素材アイテムがまとめて合成アイテムスロットに移ります。
また、レシピを覚えているため、右側の合成情報に合成時の詳細が表示します。

なお、この時表示する合成難易度値は、プラグインパラメータ`Display Difficulty`の設定で、非表示にすることができます。

![画像](image/FTKR_ItemCompositSystem/n01_009.png)

合成実行後については、素材から選ぶ場合と変わりはありません。
なお、下の図のように、合成結果には「成功」だけでなく「大成功」や「失敗」「消失」があります。

図のレシピの場合、「大成功」時にアイテムランクが上がるように設定しています。
そのため、「成功」時に「ポーション」だったものが、「大成功」では「ハイポーション」に変わります。

![画像](image/FTKR_ItemCompositSystem/n01_016.png)

[上に戻る](#合成の仕組み)　　　[目次に戻る](FTKR_ItemCompositionSystem.ja.md#目次)

## 合成の成功率
合成の成功率は、合成して出来るアイテムの難易度と、パーティーのパラメータから算出します。

### 成功率の算出
成功率は、以下の計算式で「大成功」「成功」「失敗」のそれぞれ個別に算出します。

成功率 ＝ 成功値 / プラグインパラメータ`<Max Success Rate>`の設定値

成功値 ＝ プラグインパラメータ`<Success Base Rate>`の設定値 + 成功補正値

(難易度 < パラメータ の場合)<br>
成功補正値 ＝ 難易度とパラメータの差 × `<Upper Add Rate>`の設定値(正の値)

(難易度 > パラメータ の場合)<br>
成功補正値 ＝ 難易度とパラメータの差 × `<Downer Reduce Rate>`の設定値(負の値)

アイテムの合成難易度に対して、パラメータが高ければ成功率は上がり低い場合は成功率が下がるようになっています。

[上に戻る](#合成の仕組み)　　　[目次に戻る](FTKR_ItemCompositionSystem.ja.md#目次)

### 最終的な成功率の算出
最終的に、「大成功」「成功」「失敗」「消失」のどれになるかについては、以下の計算式から算出します。

「大成功」になる確率 ＝ 「成功」の成功率 × 「大成功」の成功率<br>
「成功」になる確率　 ＝ 「成功」の成功率 - 「大成功」になる確率<br>
「失敗」になる確率　 ＝ (1 - 「成功」の成功率) × 「失敗」の成功率<br>
「消失」になる確率　 ＝ (1 - 「成功」の成功率) - 「失敗」になる確率<br>

上の計算式で分かると思いますが、「成功」の成功率が基準になっています。

[上に戻る](#合成の仕組み)　　　[目次に戻る](FTKR_ItemCompositionSystem.ja.md#目次)

### パーティーのパラメータについて
プラグインパラメータ`<Composition Parameter>`で指定した計算式を使用します。

#### 計算式 の値
計算式は、ダメージ計算式のように、計算式を入力することで、
固定値以外の値を使用することができます。以下のコードを使用できます。
* a[x].param - アクターID x のパラメータを参照します。
* s[x]    - スイッチID x の状態を参照します。
* v[x]    - 変数ID x の値を参照します。

#### 設定例
プラグインパラメータおよび、アイテムの合成難易度の設定を以下とします。
```
<Max Success Rate>  : 100
<Success Base Rate> : 80
<Upper Add Rate>    : 2
<Downer Reduce Rate>: -5
難易度: 60,50,40
```
パラメータの値が 50 だった場合、合成結果の確率は以下のようになります。

「大成功」の成功値 ＝ 80 + 10 * -5 = 30<br>
「成功」の成功値　 ＝ 80<br>
「失敗」の成功値　 ＝ 80 + 10 * 2 = 100<br>

「大成功」になる確率 ＝ 30% * 80% = 24%<br>
「成功」になる確率　 ＝ 80% - 24% = 56%<br>
「失敗」になる確率　 ＝ 20% * 100% = 20%<br>
「消失」になる確率　 ＝ 20% - 20% = 0%<br>

[上に戻る](#合成の仕組み)　　　[目次に戻る](FTKR_ItemCompositionSystem.ja.md#目次)

### パラメータを設定しない場合の最終的な成功率
プラグインパラメータ`<Composition Parameter>`に、値を設定しない場合は、アイテムに設定した難易度がそのまま最終的な成功率になります。

#### 設定例
`<Max Success Rate>`の設定値がデフォルト(100)で、アイテムに以下のように設定した場合
```
難易度: 10,50,30
```
「大成功」になる確率 ＝ 10 / 100 = 10%<br>
「成功」になる確率　 ＝ 50 / 100 = 50%<br>
「失敗」になる確率　 ＝ 30 / 100 = 30%<br>
「消失」になる確率　 ＝ (100 - (10 + 50 + 30)) / 100 = 10%<br>

[上に戻る](#合成の仕組み)　　　[目次に戻る](FTKR_ItemCompositionSystem.ja.md#目次)

## 特殊合成

### 特殊合成の仕様

特殊合成は、他の合成と異なり以下の仕様になります。

1. 素材に使用できるアイテム分類は『武器』および『防具』だけです。
1. レシピの一つ目に設定した素材をベースアイテムとします。
2. レシピの二つ目以降に設定した素材を付加アイテムとします。
   なお、「合成アイテム」タグをつけたアイテムは除きます。
3. 合成してできるアイテムは、ベースアイテムに付加アイテムの性能を一部乗せたアイテムになります。
4. 特殊合成は、レシピから選ぶことはできません。
5. 特殊合成は、ランク変更、カテゴリー変更、アイテム変更は選べません。

[上に戻る](#合成の仕組み)　　　[目次に戻る](FTKR_ItemCompositionSystem.ja.md#目次)
s
### 合成してできるアイテムの仕様

特殊合成で入手するアイテムは、他の合成と異なり以下の仕様になります。

1. アイテム分類および基本設定は、ベースアイテムと同じです。
2. 合成により、付加アイテムの能力値、または特徴をベースアイテムに付与します。
3. 付与する能力の数は、生成数に従います。
   生成数が 0 以下の場合は、何も付与しません。
4. ベースアイテムと同じ見た目ですが、ベースアイテムとは別物です。
   アイテムIDが異なりますので、『武器』・『防具』の所持数を取得する場合に別アイテムとして数えます。
5. オリジナルアイテムの名前は、「ベースアイテム名(+合成回数)」になります。

作成例）
ベースアイテムがショートソードで、合成回数が1回の場合に出来上がるアイテムは、「ショートソード(+1)」です。

![画像](image/FTKR_ItemCompositSystem/n04_002.png)

[上に戻る](#合成の仕組み)　　　[目次に戻る](FTKR_ItemCompositionSystem.ja.md#目次)

#
[トップページに戻る](README.md)